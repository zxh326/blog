---
title: '[转]反向代理层绝不能替代DNS轮询'
date: 2019-12-02T12:34:17+08:00
author: 
tags:
  - 架构
  - 负责均衡
  - DNS
  - 反向代理
  - 高可用
---

原创： 58沈剑
今天
有朋友问我，DNS轮询是不是过时的技术了？有了反向代理层（Nginx、LVS、F5等），是不是就不需要DNS轮询了？
然而，反向代理层绝不能替代DNS轮询！

### 反向代理层有什么用？架构实现时要注意什么？

* **作为服务端统一入口**，屏蔽后端WEB集群细节，代表整个WEB集群；
*画外音：这就是为啥它叫反向代理*

* **保证WEB集群的扩展性**，Nginx后端可随时加WEB实例；

* **实施负载均衡**，反向代理层会将请求均匀分发给后端WEB集群的每一个实例；

* **保证WEB集群的高可用**，任何一个WEB实例挂了，服务都不受影响；

* **注意自身高可用**，防止一台Nginx挂了，服务端统一入口受影响；
<!--more-->
### 反向代理层还存在啥问题？
反向代理层自身的扩展性问题并没有得到很好的解决，例如当Nginx成为系统瓶颈的时候，无法扩容。

### DNS轮询如何解决反向代理层的扩展性问题？
通过在DNS-server上对一个域名设置多个IP解析，能够增加入口Nginx实例个数，起到水平扩容的作用，解决反向代理层的扩展性问题。
因此，反向代理和DNS轮询并不是互斥的技术，however，这里详细展开讲一下接入层的架构渐进历程。

### 裸奔时代单机架构
![](/images/640.webp)
裸奔时代的架构图如上：

优点：
* 浏览器通过DNS-server，域名解析到ip；
* 浏览器通过ip访问web-server；

缺点：
* 非高可用，web-server挂了整个系统就挂了；
* 扩展性差，当吞吐量达到web-server上限时，无法扩容；
*画外音：单机不涉及负载均衡问题。*

### 简易扩容方案——DNS轮询
假设tomcat的吞吐量是1000次每秒，当系统总吞吐量达到3000时，如何扩容是首先要解决的问题，DNS轮询是一个很容易想到的方案。
*画外音：DNS轮询解决扩展性问题。*

![](/images/641.webp)
此时的架构图如上：

* 多部署几份web-server，1个tomcat抗1000，部署3个tomcat就能抗3000；
* 在DNS-server层面，域名每次解析到不同的ip；

优点：
* **零成本**：在DNS-server上多配几个ip即可，功能也不收费；
* **部署简单**：多部署几个web-server即可，原系统架构不需要做任何改造；
* **负载均衡**：变成了多机，负载也是均衡的；

缺点：
* **非高可用**：DNS-server只负责域名解析ip，这个ip对应的服务是否可用，DNS-server是不保证的，假设有一个web-server
挂了，部分服务会受到影响；

* **扩容非实时**：DNS解析有一个生效周期；
* **暴露了太多的外网ip**；

### 简易扩容方案——反向代理Nginx
tomcat的性能较差，但Nginx作为反向代理的性能就强很多，假设线上跑到1w，就比tomcat高了10倍，可以利用这个特性来做扩容。
![](/images/642.webp)
此时的架构图如上：
* 站点层与浏览器层之间加入了一个反向代理层，利用高性能的Nginx来做反向代理；
* Nginx将http请求分发给后端多个web-server；

优点：
* DNS-server不需要动；
* **负载均衡**：通过Nginx来保证；
* **只暴露一个外网ip**，Nginx->tomcat之间使用内网访问；
* **扩容实时**：Nginx内部可控，随时增加web-server随时实时扩容；
* **能够保证站点层的可用性**：任何一台tomcat挂了，Nginx可以将流量迁移到其他tomcat；
*画外音：反向代理，能够更实时，更方便的扩容了。*

缺点：
* **时延增加+架构更复杂了**：中间多加了一个反向代理层；
* **反向代理层成了单点**，非高可用：tomcat挂了不影响服务，Nginx挂了怎么办？
### 高可用方案——keepalived
为了解决高可用的问题，keepalived出场了。
![](/images/643.webp)

* 做两台Nginx组成一个集群，分别部署上keepalived，设置成相同的虚IP，保证Nginx的高可用；
* 当一台Nginx挂了，keepalived能够探测到，并将流量自动迁移到另一台Nginx上，整个过程对调用方透明；

![](/images/644.webp)

优点：
* 解决了高可用的问题；
*画外音：反向代理的高可用也解决了。*

缺点：
* **资源利用率只有50%**；
* Nginx仍然是接入单点，如果接入吞吐量超过的Nginx的性能上限怎么办，例如qps达到了50000咧？

### scale up扩容方案——lvs/f5
Nginx是应用软件，性能比tomcat好，但总有个上限，超出了上限，还是扛不住。
lvs就不一样了，它实施在操作系统层面；f5的性能又更好了，它实施在硬件层面；它们性能比Nginx好很多，例如每秒可以抗10w，这样可以利用他们来扩容，常见的架构图如下：
![](/images/645.webp)

* 如果通过Nginx可以扩展多个tomcat一样，可以通过lvs来扩展多个Nginx；
* 通过keepalived+VIP的方案可以保证可用性；
99.9999%的公司到这一步基本就结束了，解决了接入层高可用、扩展性、负载均衡的问题。

*画外音：上游再加一层扩充性能。*

**完美了嘛，还有什么潜在问题？**
好吧，不管是使用lvs还是f5，这些都是scale up的方案，根本上，lvs/f5还是会有性能上限，假设每秒能处理10w的请求，一天也只能处理80亿的请求（10w秒吞吐量*8w秒），那万一系统的日PV超过80亿怎么办呢？

### scale out扩容方案——DNS轮询
如之前文章所述，水平扩展，才是解决性能问题的根本方案，能够通过加机器扩充性能的方案才具备最好的扩展性。
facebook，google，baidu的PV是不是超过80亿呢，它们的域名只对应一个ip么，终点又是起点，还是得通过DNS轮询来进行扩容。
*画外音：DNS轮询解决扩展性问题。*
![](/images/646.webp)
* 通过DNS轮询来线性扩展入口lvs层的性能；
* 通过keepalived来保证高可用；
* 通过lvs来扩展多个Nginx；
* 通过Nginx来做负载均衡，业务七层路由；

### 总结
稍微做一个简要的总结：
* 接入层架构要考虑的问题域为：**高可用、扩展性、反向代理、负载均衡**；
* Nginx、keepalived、lvs、f5可以很好的解决高可用、扩展性、反向代理、负载均衡的问题；
* 水平扩展**scale out是解决扩展性问题的根本方案**，DNS轮询是不能完全被Nginx/lvs/f5所替代的；
希望大家有收获。
​